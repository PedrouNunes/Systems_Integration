<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WoT Sensor Dashboard</title>
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">üåê WoT Sensor Dashboard</h1>
    <div id="alertArea"></div>

    <!-- LED Control -->
    <div class="card p-3 mb-4">
      <h3>LED Control</h3>
      <div class="mb-2">
        <button class="btn btn-success me-2" onclick="toggleLED(true)">Turn ON</button>
        <button class="btn btn-danger" onclick="toggleLED(false)">Turn OFF</button>
      </div>
      <div class="alert alert-secondary" id="ledStatus">Status: Waiting...</div>
    </div>

    <!-- Temperature and Humidity Charts -->
    <div class="card p-3 mb-4">
      <h3>Real-time Charts</h3>
      <div class="row">
        <div class="col-md-6"><canvas id="tempChart"></canvas></div>
        <div class="col-md-6"><canvas id="humChart"></canvas></div>
      </div>
    </div>

    <!-- Acceleration Chart -->
    <div class="card p-3 mb-4">
      <h3>Acceleration (MPU6050)</h3>
      <canvas id="accelChart"></canvas>
    </div>

    <!-- Gyroscope Chart -->
    <div class="card p-3 mb-4">
      <h3>Gyroscope (MPU6050)</h3>
      <canvas id="gyroChart"></canvas>
    </div>

    <!-- Sensor Data Table with CRUD -->
    <div class="card p-3 mb-4">
      <h3 class="mb-3">Sensor Data (Last 50 entries)</h3>
      <button class="btn btn-primary mb-2" onclick="loadData()">üîÑ Refresh</button>
      <div class="table-responsive">
        <table class="table table-striped" id="sensorTable">
          <thead class="table-light">
            <tr><th>ID</th><th>Topic</th><th>Payload</th><th>Timestamp</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Payload</h5></div>
        <div class="modal-body">
          <input type="hidden" id="editId" />
          <div class="mb-3">
            <label for="editPayload" class="form-label">New Payload:</label>
            <input type="text" class="form-control" id="editPayload" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" onclick="submitEdit()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function showAlert(message, type = "info", duration = 5000) {
      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = message;
      document.getElementById("alertArea").appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), duration);
    }

    async function toggleLED(state) {
      const res = await fetch("http://localhost:3001/led", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state })
      });
      const result = await res.json();
      document.getElementById("ledStatus").textContent = res.ok ?
        `LED command sent: ${state ? "ON" : "OFF"}` :
        `Error: ${result.error || "Unknown error"}`;
    }

   async function loadData() {
    const res = await fetch("http://localhost:3001/sensors");
    const data = await res.json();
    const tbody = document.querySelector("#sensorTable tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${row.topic}</td>
        <td>${row.payload}</td>
        <td>${row.timestamp}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1">Edit</button>
          <button class="btn btn-sm btn-danger">Delete</button>
        </td>`;
      tbody.appendChild(tr);

      // Fix: bind event listeners after adding to DOM
      const [editBtn, deleteBtn] = tr.querySelectorAll("button");
      editBtn.addEventListener("click", () => openEditModal(row.id, row.payload));
      deleteBtn.addEventListener("click", () => deleteEntry(row.id));
    });
  }


    function openEditModal(id, payload) {
      document.getElementById("editId").value = id;
      document.getElementById("editPayload").value = payload;
      new bootstrap.Modal(document.getElementById("editModal")).show();
    }

    async function submitEdit() {
      const id = document.getElementById("editId").value;
      const payload = document.getElementById("editPayload").value;

      const res = await fetch(`http://localhost:3001/sensors/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ payload })
      });

      const result = await res.json();
      if (res.ok) {
        showAlert("‚úÖ Payload updated!", "success");
        loadData();
      } else {
        showAlert(`‚ùå Update failed: ${result.error}`, "danger");
      }
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    }

    async function deleteEntry(id) {
      if (!confirm(`Are you sure you want to delete entry ID ${id}?`)) return;

      const res = await fetch(`http://localhost:3001/sensors/${id}`, {
        method: "DELETE"
      });

      const result = await res.json();
      if (res.ok) {
        showAlert("üóëÔ∏è Entry deleted.", "warning");
        loadData();
      } else {
        showAlert(`‚ùå Delete failed: ${result.error}`, "danger");
      }
    }

    // Chart structures
    const tempData = { labels: [], datasets: [{ label: "Temperature (¬∞C)", data: [], borderColor: "rgba(255,99,132,1)", backgroundColor: "rgba(255,99,132,0.2)", tension: 0.3 }] };
    const humData  = { labels: [], datasets: [{ label: "Humidity (%)", data: [], borderColor: "rgba(54,162,235,1)", backgroundColor: "rgba(54,162,235,0.2)", tension: 0.3 }] };

    const accelData = {
      labels: [],
      datasets: [
        { label: "AcX", data: [], borderColor: "orange", backgroundColor: "orange", tension: 0.3 },
        { label: "AcY", data: [], borderColor: "purple", backgroundColor: "purple", tension: 0.3 },
        { label: "AcZ", data: [], borderColor: "green", backgroundColor: "green", tension: 0.3 }
      ]
    };

    const gyroData = {
      labels: [],
      datasets: [
        { label: "GyX", data: [], borderColor: "gold", backgroundColor: "gold", tension: 0.3 },
        { label: "GyY", data: [], borderColor: "gray", backgroundColor: "gray", tension: 0.3 },
        { label: "GyZ", data: [], borderColor: "blue", backgroundColor: "blue", tension: 0.3 }
      ]
    };

    const tempChart  = new Chart(document.getElementById("tempChart"), { type: "line", data: tempData });
    const humChart   = new Chart(document.getElementById("humChart"), { type: "line", data: humData });
    const accelChart = new Chart(document.getElementById("accelChart"), { type: "line", data: accelData });
    const gyroChart  = new Chart(document.getElementById("gyroChart"), { type: "line", data: gyroData });

    const limitData = (chart) => {
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
      }
    };

    window.onload = loadData;

    const mqttClient = mqtt.connect("ws://192.168.1.241:9001");

    mqttClient.on("connect", () => {
      console.log("Connected to MQTT broker (WebSocket)");
      mqttClient.subscribe("sensor/temperature");
      mqttClient.subscribe("sensor/humidity");
      mqttClient.subscribe("sensor/motion");
      mqttClient.subscribe("alert/motion");
      mqttClient.subscribe("alert/climate");
    });

    mqttClient.on("message", (topic, message) => {
      const payload = message.toString();
      const time = new Date().toLocaleTimeString();
      const statusDiv = document.getElementById("ledStatus");

      if (topic === "sensor/temperature") {
        const value = parseFloat(payload);
        statusDiv.innerHTML = `Temperature: ${value} ¬∞C`;
        tempData.labels.push(time);
        tempData.datasets[0].data.push(value);
        limitData(tempChart); tempChart.update();

      } else if (topic === "sensor/humidity") {
        const value = parseFloat(payload);
        statusDiv.innerHTML += `<br>Humidity: ${value} %`;
        humData.labels.push(time);
        humData.datasets[0].data.push(value);
        limitData(humChart); humChart.update();

      } else if (topic === "sensor/motion") {
        try {
          const m = JSON.parse(payload);
          accelData.labels.push(time);
          accelData.datasets[0].data.push(m.AcX);
          accelData.datasets[1].data.push(m.AcY);
          accelData.datasets[2].data.push(m.AcZ);
          gyroData.labels.push(time);
          gyroData.datasets[0].data.push(m.GyX);
          gyroData.datasets[1].data.push(m.GyY);
          gyroData.datasets[2].data.push(m.GyZ);

          limitData(accelChart); accelChart.update();
          limitData(gyroChart);  gyroChart.update();
        } catch (e) {
          console.error("Invalid motion payload", payload);
        }

      } else if (topic === "alert/motion" && payload === "1") {
        showAlert("üö® Motion detected!", "danger");
      } else if (topic === "alert/climate" && payload === "1") {
        showAlert("‚ö†Ô∏è Climate alert triggered!", "warning");
      }
    });
  </script>

  <!-- Bootstrap JS (required for modals) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
