<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WoT Sensor Dashboard</title>

  <!-- Bootstrap local -->
  <link rel="stylesheet" href="css/bootstrap.min.css" />

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">üåê WoT Sensor Dashboard</h1>

    <!-- LED Control -->
    <div class="card p-3 mb-4">
      <h3>LED Control</h3>
      <div class="mb-2">
        <button class="btn btn-success me-2" onclick="toggleLED(true)">Turn ON</button>
        <button class="btn btn-danger" onclick="toggleLED(false)">Turn OFF</button>
      </div>
      <div class="alert alert-secondary" id="ledStatus">Status: Waiting...</div>
    </div>

    <!-- Temperature and Humidity Charts -->
    <div class="card p-3 mb-4">
      <h3>Real-time Charts</h3>
      <div class="row">
        <div class="col-md-6">
          <canvas id="tempChart"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="humChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Motion Chart -->
    <div class="card p-3 mb-4">
      <h3>Real-time Motion (MPU6050)</h3>
      <canvas id="motionChart"></canvas>
    </div>

    <!-- Sensor Data Table -->
    <div class="card p-3 mb-4">
      <h3 class="mb-3">Sensor Data (Last 50 entries)</h3>
      <button class="btn btn-primary mb-2" onclick="loadData()">üîÑ Refresh</button>
      <div class="table-responsive">
        <table class="table table-striped" id="sensorTable">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Topic</th>
              <th>Payload</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Toggle LED via REST
    async function toggleLED(state) {
      const res = await fetch("http://localhost:3001/led", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state })
      });

      const result = await res.json();
      const statusDiv = document.getElementById("ledStatus");
      if (res.ok) {
        statusDiv.textContent = `LED command sent: ${state ? "ON" : "OFF"}`;
      } else {
        statusDiv.textContent = `Error: ${result.error || "Unknown error"}`;
      }
    }

    // Load sensor data via REST
    async function loadData() {
      const res = await fetch("http://localhost:3001/sensors");
      const data = await res.json();

      const tbody = document.querySelector("#sensorTable tbody");
      tbody.innerHTML = "";

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.topic}</td>
          <td>${row.payload}</td>
          <td>${row.timestamp}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Initialize charts
    const tempData = {
      labels: [],
      datasets: [{
        label: "Temperature (¬∞C)",
        data: [],
        borderColor: "rgba(255, 99, 132, 1)",
        backgroundColor: "rgba(255, 99, 132, 0.2)",
        tension: 0.3
      }]
    };

    const humData = {
      labels: [],
      datasets: [{
        label: "Humidity (%)",
        data: [],
        borderColor: "rgba(54, 162, 235, 1)",
        backgroundColor: "rgba(54, 162, 235, 0.2)",
        tension: 0.3
      }]
    };

    const motionData = {
      labels: [],
      datasets: [
        {
          label: "AcX",
          data: [],
          borderColor: "rgba(255, 159, 64, 1)",
          backgroundColor: "rgba(255, 159, 64, 0.2)",
          tension: 0.3
        },
        {
          label: "AcY",
          data: [],
          borderColor: "rgba(153, 102, 255, 1)",
          backgroundColor: "rgba(153, 102, 255, 0.2)",
          tension: 0.3
        },
        {
          label: "AcZ",
          data: [],
          borderColor: "rgba(75, 192, 192, 1)",
          backgroundColor: "rgba(75, 192, 192, 0.2)",
          tension: 0.3
        }
      ]
    };

    const tempChart = new Chart(document.getElementById("tempChart"), {
      type: "line",
      data: tempData
    });

    const humChart = new Chart(document.getElementById("humChart"), {
      type: "line",
      data: humData
    });

    const motionChart = new Chart(document.getElementById("motionChart"), {
      type: "line",
      data: motionData
    });

    // Load data when page loads
    window.onload = loadData;

    // MQTT connection
    const mqttClient = mqtt.connect("ws://192.168.1.241:9001");

    mqttClient.on("connect", () => {
      console.log("‚úÖ Connected to MQTT broker (WebSocket)");
      mqttClient.subscribe("sensor/temperature");
      mqttClient.subscribe("sensor/humidity");
      mqttClient.subscribe("sensor/motion");
      mqttClient.subscribe("alert/motion");
      mqttClient.subscribe("alert/climate");
    });

    mqttClient.on("message", (topic, message) => {
      const payload = message.toString();
      const statusDiv = document.getElementById("ledStatus");
      const timestamp = new Date().toLocaleTimeString();

      if (topic === "sensor/temperature") {
        const value = parseFloat(payload);
        statusDiv.innerHTML = `üå°Ô∏è Temperature: ${value} ¬∞C`;

        tempData.labels.push(timestamp);
        tempData.datasets[0].data.push(value);
        if (tempData.labels.length > 20) {
          tempData.labels.shift();
          tempData.datasets[0].data.shift();
        }
        tempChart.update();

      } else if (topic === "sensor/humidity") {
        const value = parseFloat(payload);
        statusDiv.innerHTML += `<br>üíß Humidity: ${value} %`;

        humData.labels.push(timestamp);
        humData.datasets[0].data.push(value);
        if (humData.labels.length > 20) {
          humData.labels.shift();
          humData.datasets[0].data.shift();
        }
        humChart.update();

      } else if (topic === "sensor/motion") {
        try {
          const motion = JSON.parse(payload);
          motionData.labels.push(timestamp);
          motionData.datasets[0].data.push(motion.AcX);
          motionData.datasets[1].data.push(motion.AcY);
          motionData.datasets[2].data.push(motion.AcZ);
          if (motionData.labels.length > 20) {
            motionData.labels.shift();
            motionData.datasets.forEach(ds => ds.data.shift());
          }
          motionChart.update();
        } catch (e) {
          console.error("Invalid motion payload:", payload);
        }

      } else if (topic === "alert/motion" && payload === "1") {
        alert("üö® Motion detected!");
      } else if (topic === "alert/climate" && payload === "1") {
        alert("‚ö†Ô∏è Climate alert triggered!");
      }
    });
  </script>
</body>
</html>
